# Implementation Plan: Task CRUD REST API

**Branch**: `004-task-crud-api` | **Date**: 2026-02-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-task-crud-api/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement RESTful API endpoints for task management (Create, Read, Update, Delete, Toggle Completion). All endpoints require JWT authentication and enforce strict user ownership isolation. Built with FastAPI backend, using SQLModel ORM for PostgreSQL access, following RESTful conventions.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI, SQLModel, PyJWT, Pydantic v2, psycopg2-binary
**Storage**: Neon Serverless PostgreSQL (via SQLModel ORM)
**Testing**: pytest, httpx (TestClient), pytest-asyncio
**Target Platform**: Backend API server (Linux/Docker)
**Project Type**: Web backend (REST API)
**Performance Goals**: P95 latency <200ms for CRUD operations, P99 <500ms
**Constraints**: JWT required on ALL endpoints, user isolation enforced on ALL queries, RESTful conventions mandatory
**Scale/Scope**: 6 API endpoints, user-scoped task operations, stateless authentication

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Security-By-Design (NON-NEGOTIABLE)
- [x] JWT authentication required on ALL endpoints (via `Depends(get_current_user_id)`)
- [x] User isolation: All queries filtered by `authenticated_user_id`
- [x] URL `user_id` verified against JWT token `user_id` (403 on mismatch)
- [x] Pydantic schemas for input validation
- [x] HTTPException for error responses with standard status codes

### ✅ Strict Architectural Boundaries
- [x] Backend-only feature (no frontend changes in this spec)
- [x] FastAPI framework with async/await route handlers
- [x] SQLModel ORM exclusively (no raw SQL)
- [x] Database access through dependency injection (`Depends(get_session)`)

### ✅ API-First Design
- [x] RESTful conventions (GET, POST, PUT, DELETE, PATCH)
- [x] Standard HTTP status codes (200, 201, 204, 400, 401, 403, 404, 422)
- [x] JSON request/response bodies
- [x] All endpoints under `/api/{user_id}/` prefix
- [x] OpenAPI documentation auto-generated by FastAPI

### ✅ Test-Driven Development
- [x] Integration tests for all 6 endpoints with JWT authentication
- [x] Unit tests for authorization logic
- [x] Test cases for edge cases (missing token, user mismatch, non-existent tasks)
- [x] 100% endpoint coverage required

### ✅ Spec-First Development
- [x] Complete feature spec in `/specs/004-task-crud-api/spec.md`
- [x] Implementation plan in `/specs/004-task-crud-api/plan.md` (this file)
- [x] Task breakdown will be in `/specs/004-task-crud-api/tasks.md` (Phase 2)

**GATE STATUS**: ✅ PASS - All constitution requirements satisfied

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── main.py              # FastAPI application entry point (existing)
├── models.py            # SQLModel database models (existing: User, Task)
├── db.py                # Database connection and session management (existing)
├── auth.py              # JWT verification middleware (existing: get_current_user_id)
├── routes/
│   └── tasks.py         # NEW: Task CRUD API endpoints (6 routes)
├── schemas.py           # NEW: Pydantic request/response schemas (TaskCreate, TaskUpdate, TaskResponse)
├── requirements.txt     # Python dependencies (existing, may need updates)
└── .env                 # Environment variables (BETTER_AUTH_SECRET, DATABASE_URL)

tests/
├── test_tasks.py        # NEW: Integration tests for task endpoints
├── conftest.py          # NEW: Test fixtures (test client, test tokens, test database)
└── __init__.py          # Test package marker

frontend/
└── [NOT MODIFIED IN THIS FEATURE]
```

**Structure Decision**: This is a web application with separate backend and frontend. This feature only modifies the backend layer, adding task CRUD endpoints. The frontend directory remains untouched. Backend follows FastAPI project structure with routes organized by resource (tasks). SQLModel models already exist (User, Task from Feature 003), so this feature adds route handlers and Pydantic schemas only.

## Complexity Tracking

No constitution violations. All requirements align with constitutional standards.

## Phase 0: Research & Clarifications

**Status**: No research required - all technical decisions already established in constitution and Feature 002/003 dependencies.

**Key Decisions** (from existing architecture):
- **Decision**: Use FastAPI with async/await route handlers
  - **Rationale**: Constitution mandates FastAPI framework
  - **Alternatives**: Django REST Framework, Flask - rejected per constitution

- **Decision**: SQLModel ORM for database queries
  - **Rationale**: Constitution prohibits raw SQL
  - **Alternatives**: SQLAlchemy Core, raw psycopg2 - rejected per constitution

- **Decision**: JWT authentication via `Depends(get_current_user_id)`
  - **Rationale**: Feature 002 authentication dependency provides this
  - **Alternatives**: Custom auth logic - rejected (reuse existing dependency)

- **Decision**: RESTful API conventions (GET, POST, PUT, DELETE, PATCH)
  - **Rationale**: Constitution API-First Design section mandates REST
  - **Alternatives**: GraphQL, gRPC - rejected per constitution

- **Decision**: Pydantic v2 for request/response validation
  - **Rationale**: FastAPI integrates Pydantic natively
  - **Alternatives**: Marshmallow, Cerberus - rejected (FastAPI native is preferred)

**No research.md file required** - all technical context resolved.

## Phase 1: Design & Contracts

### Data Model

**Entity: Task** (already exists from Feature 003)
```python
class Task(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="user.id", index=True)  # Foreign key to User
    title: str = Field(max_length=200)
    description: str | None = Field(default=None, max_length=1000)
    completed: bool = Field(default=False)
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    updated_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
```

**No data model changes required** - existing Task model satisfies all requirements.

### Request/Response Schemas

**schemas.py** (new file):

```python
from pydantic import BaseModel, Field
from datetime import datetime

class TaskCreate(BaseModel):
    """Request body for creating a new task."""
    title: str = Field(..., min_length=1, max_length=200, description="Task title (required)")
    description: str | None = Field(None, max_length=1000, description="Optional task description")

class TaskUpdate(BaseModel):
    """Request body for updating a task (all fields optional)."""
    title: str | None = Field(None, min_length=1, max_length=200)
    description: str | None = Field(None, max_length=1000)
    completed: bool | None = None

class TaskResponse(BaseModel):
    """Response body for task operations."""
    id: int
    user_id: str
    title: str
    description: str | None
    completed: bool
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True  # Enable ORM mode for SQLModel compatibility
```

### API Contracts

**File**: `specs/004-task-crud-api/contracts/task-api.yaml`

```yaml
openapi: 3.0.3
info:
  title: Task CRUD API
  version: 1.0.0
  description: RESTful API for managing user tasks with JWT authentication

paths:
  /api/{user_id}/tasks:
    get:
      summary: List all tasks for authenticated user
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Array of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Create a new task
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/{user_id}/tasks/{id}:
    get:
      summary: Get a specific task
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update a task
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Task updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete a task
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Task deleted successfully (no content)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/{user_id}/tasks/{id}/complete:
    patch:
      summary: Toggle task completion status
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task completion toggled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    TaskCreate:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 1000

    TaskUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 1000
        completed:
          type: boolean

    TaskResponse:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        completed:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Invalid input
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
    Unauthorized:
      description: Missing or invalid JWT token
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
    Forbidden:
      description: Valid token but insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
```

### Quickstart Guide

**File**: `specs/004-task-crud-api/quickstart.md`

```markdown
# Task CRUD API - Quickstart Guide

## Prerequisites

- Backend running (Feature 002: Authentication implemented)
- Database with User and Task models (Feature 003)
- Valid JWT token from authentication

## Authentication

All requests require JWT token in Authorization header:

```bash
Authorization: Bearer <jwt_token>
```

## Example Requests

### 1. List All Tasks

```bash
curl -X GET http://localhost:8000/api/user-123/tasks \
  -H "Authorization: Bearer <jwt_token>"
```

Response (200 OK):
```json
[
  {
    "id": 1,
    "user_id": "user-123",
    "title": "Buy groceries",
    "description": "Milk, bread, eggs",
    "completed": false,
    "created_at": "2026-02-07T10:00:00Z",
    "updated_at": "2026-02-07T10:00:00Z"
  }
]
```

### 2. Create New Task

```bash
curl -X POST http://localhost:8000/api/user-123/tasks \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Finish project",
    "description": "Complete all remaining tasks"
  }'
```

Response (201 Created):
```json
{
  "id": 2,
  "user_id": "user-123",
  "title": "Finish project",
  "description": "Complete all remaining tasks",
  "completed": false,
  "created_at": "2026-02-07T10:05:00Z",
  "updated_at": "2026-02-07T10:05:00Z"
}
```

### 3. Get Single Task

```bash
curl -X GET http://localhost:8000/api/user-123/tasks/1 \
  -H "Authorization: Bearer <jwt_token>"
```

Response (200 OK): Same as create response

### 4. Update Task

```bash
curl -X PUT http://localhost:8000/api/user-123/tasks/1 \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Buy groceries (updated)",
    "completed": true
  }'
```

Response (200 OK): Updated task object

### 5. Toggle Completion

```bash
curl -X PATCH http://localhost:8000/api/user-123/tasks/1/complete \
  -H "Authorization: Bearer <jwt_token>"
```

Response (200 OK): Task with toggled completion status

### 6. Delete Task

```bash
curl -X DELETE http://localhost:8000/api/user-123/tasks/1 \
  -H "Authorization: Bearer <jwt_token>"
```

Response (204 No Content): Empty response

## Error Responses

### 401 Unauthorized (Missing/Invalid Token)

```json
{
  "detail": "Not authenticated"
}
```

### 403 Forbidden (User Mismatch)

```json
{
  "detail": "Access denied"
}
```

### 404 Not Found (Task Doesn't Exist)

```json
{
  "detail": "Task not found"
}
```

### 400 Bad Request (Validation Error)

```json
{
  "detail": "Title is required and must be between 1 and 200 characters"
}
```

## Testing with pytest

Run integration tests:

```bash
cd backend
pytest tests/test_tasks.py -v
```

Run with coverage:

```bash
pytest tests/test_tasks.py --cov=routes.tasks --cov-report=term-missing
```

## Dependencies

This feature depends on:
- **Feature 002**: Authentication (get_current_user_id dependency)
- **Feature 003**: Database models (User, Task models)
- **Constitution**: Security and architectural requirements
```

## Phase 2: Implementation Planning

**This phase is handled by the `/sp.tasks` command** - NOT by `/sp.plan`.

The `/sp.tasks` command will generate a detailed task breakdown in `specs/004-task-crud-api/tasks.md` based on this implementation plan.

## Summary

**Planning Complete**:
- ✅ Technical context established (Python 3.11+, FastAPI, SQLModel, JWT auth)
- ✅ Constitution check passed (all requirements satisfied)
- ✅ Project structure defined (backend routes, schemas, tests)
- ✅ Data model reviewed (existing Task model sufficient)
- ✅ API contracts documented (OpenAPI spec for 6 endpoints)
- ✅ Quickstart guide created (example requests and testing)

**Next Steps**:
1. Run `/sp.tasks` to generate task breakdown
2. Run `/sp.implement` to execute tasks
3. Validate implementation against spec acceptance criteria
4. Run security audit with auth-security-specialist agent
5. Run architecture audit with architecture-boundary-guardian agent
